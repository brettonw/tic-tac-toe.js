<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="icon.png?1"/>
    <link rel="stylesheet" href="test.css" />
    <title>Tic-Tac-Toe</title>
</head>
<body>
</body>
</html>

<script src="https://bedrock.brettonw.com/dist/latest/bedrock-debug.js"></script>
<script>let Enum = Bedrock.Enum; </script>
<script src="src/main/js/tic-tac-toe.js"></script>
<script src="src/test/js/test-harness.js"></script>
<script src="src/test/js/tic-tac-toe.js"></script>

<script>
    let Builder = Bedrock.Html.Builder;
    let body = document.getElementsByTagName("body")[0];

    let parent = body;
    let bound = parent.getClientRects()[0];
    let svgRoot = Builder
        .begin("svg", {
            id: "svg-root",
            onmousedown: "handleSvgMouseDown (event);",
            onmouseup: "handleSvgMouseUp (event);",
            onmousemove: "handleSvgMouseMove (event);",
            onwheel: "handleSvgWheel (event);",
            width: bound.width,
            height: bound.height
        })

        .begin ("g", { id: "g-root", class: "fill" })
        .begin ("g", { id: "g-view", class: "fill" })
        .add ("circle", {
            cx:"0",
            cy:"0",
            r:"0.5",
            stroke:"black",
            "stroke-width":"0.1",
            fill:"yellow"
        })
        .end ()
        .end ()
        .end ();
    parent.appendChild(svgRoot);

    let scale = Math.min (bound.width, bound.height);
    let translateX = bound.width / (2 * scale);
    let translateY = bound.height / (2 * scale);
    let gRoot = document.getElementById("g-root");
    gRoot.setAttribute("transform", "scale(" + scale + ") translate(" + translateX + "," + translateY + ")");

    let gView = document.getElementById("g-view");
    let viewTranslateX = 0;
    let viewTranslateY = 0;
    let viewScales = [];

    // generate a bunch of steps for zooming smoothly, this uses a square root
    // curve for a perceptually linear progression. The values are scaled so that
    // we start with a zoom factor at exactly 1.0
    let rangeMin = 0.0125;
    let rangeMax = 2.0;
    let steps = 40;
    let viewScaleIndex = Math.round(Math.sqrt ((1 - rangeMin) / rangeMax) * steps);
    let viewScaleNormalizer = viewScaleIndex / steps;
    viewScaleNormalizer = rangeMin + ((viewScaleNormalizer * viewScaleNormalizer) * rangeMax)
    for (let i = 0; i <= steps; ++i) {
        let delta = i / steps;
        let viewScale = (rangeMin + ((delta * delta) * rangeMax)) / viewScaleNormalizer;
        viewScales.push(viewScale);
    }

    let setViewTransform = function () {
        gView.setAttribute("transform", "translate(" + viewTranslateX + "," + viewTranslateY + ") scale(" + viewScales[viewScaleIndex] + ")");
    };
    setViewTransform ();

    let mouseDownEvent = null;
    let oldViewTranslateX, oldViewTranslateY;
    let handleSvgMouseDown = function (event) {
        mouseDownEvent = event;
        oldViewTranslateX = viewTranslateX;
        oldViewTranslateY = viewTranslateY;
        console.log ("down");
    };

    let handleSvgMouseUp = function (event) {
        mouseDownEvent = null;
        console.log ("up");
    };

    let handleSvgMouseMove = function (event) {
        if (mouseDownEvent !== null) {
            console.log ("move");
            let deltaX = (event.offsetX - mouseDownEvent.offsetX) / scale;
            let deltaY = (event.offsetY - mouseDownEvent.offsetY) / scale;
            viewTranslateX = oldViewTranslateX + deltaX;
            viewTranslateY = oldViewTranslateY + deltaY;
            setViewTransform();
        }
    };

    let handleSvgWheel = function (event) {
        console.log ("wheel");
        viewScaleIndex = Math.max (0, Math.min (viewScales.length - 1, viewScaleIndex + (event.wheelDeltaY / Math.abs(event.wheelDeltaY))));
        setViewTransform();
    };
</script>
