<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="icon.png?1"/>
    <link rel="stylesheet" href="https://bedrock.brettonw.com/dist/latest/bedrock.css" />
    <link rel="stylesheet" href="test.css" />
    <title>Tic-Tac-Toe</title>
</head>
<body id="body">
</body>
</html>

<script src="https://bedrock.brettonw.com/dist/latest/bedrock-debug.js"></script>
<script>let Enum = Bedrock.Enum; </script>
<script src="src/main/js/tic-tac-toe.js"></script>
<script src="src/test/js/test-harness.js"></script>
<script src="src/test/js/tic-tac-toe.js"></script>

<script>

    let SvgTransformer = function () {
        let _ = Object.create(Bedrock.Base);

        // generate a bunch of zoom steps for zooming smoothly, this uses a
        // quadratic curve for a perceptually linear progression. The values are
        // scaled so that we start with a zoom factor at exactly 1.0
        let rangeMin = 0.0125;
        let rangeMax = 2.0;
        let steps = 40;
        let viewScale1 = Math.round (Math.sqrt ((1 - rangeMin) / rangeMax) * steps);
        let viewScaleNormalizer = viewScale1 / steps;
        viewScaleNormalizer = rangeMin + ((viewScaleNormalizer * viewScaleNormalizer) * rangeMax)
        let viewScales = [];
        for (let i = 0; i <= steps; ++i) {
            let delta = i / steps;
            let viewScale = (rangeMin + ((delta * delta) * rangeMax)) / viewScaleNormalizer;
            viewScales.push (viewScale);
        }

        _.init = function (parameters) {
            this.view = parameters.view;
            this.rootScale = parameters.rootScale;
            this.x = 0;
            this.y = 0;
            this.si = viewScale1;
            this.mouseDownEvent = null;
            return this;
        };

        _.setTransform = function () {
            this.view.setAttribute ("transform", "translate(" + this.x + "," + this.y + ") scale(" + viewScales[this.si] + ")");
        };

        _.handleSvgMouseDown = function (event) {
            this.mouseDownEvent = event;
            this.oldX = this.x;
            this.oldY = this.y;
            //console.log ("down");
        };

        _.handleSvgMouseUp = function (event) {
            this.mouseDownEvent = null;
            //console.log ("up");
        };

        _.handleSvgMouseMove = function (event) {
            if (this.mouseDownEvent !== null) {
                //console.log ("move");
                this.x = this.oldX + ((event.offsetX - this.mouseDownEvent.offsetX) / this.rootScale);
                this.y = this.oldY + ((event.offsetY - this.mouseDownEvent.offsetY) / this.rootScale);
                this.setTransform ();
            }
        };

        _.handleSvgWheel = function (event) {
            //console.log ("wheel");
            this.si = Math.max (0, Math.min (viewScales.length - 1, this.si + (event.wheelDeltaY / Math.abs (event.wheelDeltaY))));
            this.setTransform ();
        };

        return _;
    } ();


    let addSvg = function (parent) {
        let svgRoot = Bedrock.Html.Builder
            .begin ("http://www.w3.org/2000/svg;svg", {
                id: parent.id + "-svg-root",
                attributes: {
                    onmousedown: "this.svgTransformer.handleSvgMouseDown (event);" ,
                    onmouseup: "this.svgTransformer.handleSvgMouseUp (event);",
                    onmousemove: "this.svgTransformer.handleSvgMouseMove (event);",
                    onwheel: "this.svgTransformer.handleSvgWheel (event);",
                    width: "100%",
                    height: "100%",
                }
            })

            .begin ("http://www.w3.org/2000/svg;g", { id: parent.id + "-root-g" })
            .add ("http://www.w3.org/2000/svg;g", { id: parent.id + "-view-g" })
            .end ()
            .end ();
        parent.appendChild (svgRoot);

        let rootG = document.getElementById (parent.id + "-root-g");
        let viewG = document.getElementById (parent.id + "-view-g");
        let clientG = Bedrock.Html.Builder.add ("http://www.w3.org/2000/svg;g");
        viewG.appendChild(clientG);

        let bound = svgRoot.getBoundingClientRect ();
        let scale = Math.min (bound.width, bound.height);
        let translateX = bound.width / (2 * scale);
        let translateY = bound.height / (2 * scale);
        rootG.setAttribute ("transform", "scale(" + scale + ") translate(" + translateX + "," + translateY + ")");

        // create a transformer object to manipulate the view
        svgRoot.svgTransformer = SvgTransformer.new ({ view: viewG, rootScale: scale });
        return clientG;
    };

    let body = document.getElementsByTagName("body")[0];
    let svgClient = addSvg(body);

    svgClient.appendChild(Bedrock.Html.Builder
        .add ("http://www.w3.org/2000/svg;circle", {
            attributes: {
                cx: "0",
                cy: "0",
                r: "0.5",
                stroke: "black",
                "stroke-width": "0.1",
                fill: "yellow"
            }
        })
    );
</script>
